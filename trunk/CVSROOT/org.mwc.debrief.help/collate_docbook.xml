<?xml version="1.0" encoding="UTF-8"?>
<project name="org.mwc.debrief.help" default="docbook_to_eclipse" basedir=".">

	<!-- and the cvs-logging related ones -->
	<property name="contribDir" value="../contribs" />
	<property name="sourceDir" value="../" description="top level directory within which all our sources are stored" />
	<property name="buildCVSLogDir" value="${deployDir}/cvs" />	
	
	<!-- and the docbook/help related bits -->
	<property name="contribDir" value="../contribs" />
	<property name="helpDir" value="./" />
	<property name="helpDest" value="${helpDir}\html\legacy" />
	
	<target name="_log1_produce" description="produce the cvs change logs">

		<!-- clear the output directory -->
		<delete dir="${buildCVSLogDir}" />

		<!-- create the output directory if we have to -->
		<mkdir dir="${buildCVSLogDir}" />
		<mkdir dir="${buildCVSLogDir}/statcvs" />

		<!-- produce the CVS log -->
		<cvs quiet="yes" dest="${sourceDir}" output="${buildCVSLogDir}/statcvs.log">
			<commandline>
				<argument line="log " />
			</commandline>
		</cvs>
	</target>




	<target name="_log2_format" description="use the stylesheet tidier">
		<antcall target="_cvs_stat_formatter">
			<param name="cvs_stat_outputDir" value="${buildCVSLogDir}/statcvs/short" />
			<param name="cvs_stat_stylesheet" value="org.mwc.cmap.installer/statcvs_template/single_page_suite.xml" />
			<param name="cvs_stat_outputTitle" value="Abbreviated change statistics" />
		</antcall>

		<antcall target="_cvs_stat_formatter">
			<param name="cvs_stat_outputDir" value="${buildCVSLogDir}/statcvs/long" />
			<param name="cvs_stat_stylesheet" value="org.mwc.cmap.installer/statcvs_template/suite.xml" />
			<param name="cvs_stat_outputTitle" value="Verbose change statistics" />
		</antcall>

	</target>


	<target name="_log3_copy" description="copy the tidy cvs logs to the help structure so that they can be included in help-references">
		<copy todir="..\org.mwc.debrief.help\html\history">
			<fileset dir="${buildCVSLogDir}" />
		</copy>
	</target>

	<target name="cvs_log" description="do the steps to produce a cvs log">
		<antcall target="_log1_produce" />
		<antcall target="_log2_format" />
		<antcall target="_log3_copy" />
	</target>	


	<target name="clear_output" description="ditch the existing output files">
		<delete dir="${helpDest}" />
	</target>
	
	<target name="docbook_to_eclipse" description="Generate html from docbook">
		<!-- clear the output directories -->
		<antcall target="clear_output"></antcall>
		
		<!-- generate the output -->
		<mkdir dir="${helpDest}" />

		<!-- generate the HTML -->
		<java classpath="${contribDir}\saxon6_5_2\saxon.jar" fork="yes" dir="${helpDest}" classname="com.icl.saxon.StyleSheet" maxmemory="128m">
			<arg value="D:\Dev\Eclipse2\org.mwc.debrief.help\docbook/ng_help.xml" />
			<arg value="D:\Dev\Eclipse2\org.mwc.debrief.help\docbook/eclipse_html_style.xsl" />
		</java>
		
		<!-- hey, to maintain the correct document locations, we've got to copy the generated content back
		  into the top-level of the docbook output directories -->
		<copy todir="${helpDest}\" preservelastmodified="yes">
			<fileset dir="${helpDest}\html\legacy" />
		</copy>
		<!-- and delete the duff directory (to stop us getting confused... -->
		<delete dir="${helpDest}\html\legacy" />
		
		
		<!-- also copy the images to the target directory -->
		<copy todir="${helpDest}\figures" preservelastmodified="yes">
			<fileset dir="${helpDir}\docbook/figures" />
		</copy>
		<copy todir="${helpDest}\images" preservelastmodified="yes">
			<fileset dir="${helpDir}\docbook/images" />
		</copy>
		<!-- and the stylesheet -->
		<copy todir="${helpDest}" preservelastmodified="yes">
			<fileset file="${helpDir}\docbook/header.css" />
		</copy>
		
	</target>

	<!--
	######################################################################################
	##	utility tasks
	######################################################################################
	  -->

	<target name="_cvs_stat_formatter" description="use the stylesheet tidier">
		<!-- ok, delete the output directory -->
		<delete dir="${cvs_stat_outputDir}" />

		<!-- and create it afresh -->
		<mkdir dir="${cvs_stat_outputDir}" />

		<!-- and produce the output -->
		<java dir="${sourceDir}" jar="${contribDir}/statcvs/statcvs-xml-0.9.4-full.jar" fork="true">
			<jvmarg line="-mx128m" />
			<arg line=" -output-dir ${cvs_stat_outputDir}
	            -title '${cvs_stat_outputTitle}'
	            -suite ${cvs_stat_stylesheet}
				deploy/cvs/statcvs.log" />
		</java>
	</target>
	
	
</project>